<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0081)https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md -->
<html class="doc-page"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>GN Language and Operation</title><link rel="stylesheet" type="text/css" href="./GN Language and Operation_files/doc.0L3SNFV84koi7_B276HAQw.cache.css"><link rel="stylesheet" type="text/css" href="./GN Language and Operation_files/prettify.pZ5FqzM6cPxAflH0va2Ucw.cache.css"></head><body><div class="doc"><h1><a class="h" name="GN-Language-and-Operation" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#GN-Language-and-Operation"><span></span></a>GN Language and Operation</h1><div class="toc" role="navigation"><h2>Contents</h2><div class="toc-aux"><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#GN-Language-and-Operation">GN Language and Operation</a></li><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Introduction">Introduction</a></li><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Use-the-built_in-help">Use the built-in help!</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Design-philosophy">Design philosophy</a></li></ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Language">Language</a></li><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Strings">Strings</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Lists">Lists</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Conditionals">Conditionals</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Functions">Functions</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Scoping-and-execution">Scoping and execution</a></li></ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Naming-things">Naming things</a></li><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#File-and-directory-names">File and directory names</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Labels">Labels</a></li></ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Build-configuration">Build configuration</a></li><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Overall-build-flow">Overall build flow</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#The-build-config-file">The build config file</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Build-arguments">Build arguments</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Target-defaults">Target defaults</a></li></ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Targets">Targets</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Configs">Configs</a></li><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Public-configs">Public configs</a></li></ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Toolchains">Toolchains</a></li><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Toolchains-and-the-build-configuration">Toolchains and the build configuration</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Toolchain-example">Toolchain example</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Declaring-a-toolchain">Declaring a toolchain</a></li></ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Templates">Templates</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Other-features">Other features</a></li><ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Imports">Imports</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Path-processing">Path processing</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Patterns">Patterns</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Executing-scripts">Executing scripts</a></li></ul></ul><li><a href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Differences-and-similarities-to-Blaze">Differences and similarities to Blaze</a></li></ul></div></div><h2><a class="h" name="Introduction" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Introduction"><span></span></a>Introduction</h2><p>This page describes many of the language details and behaviors.</p><h3><a class="h" name="Use-the-built_in-help" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Use-the-built_in-help"><span></span></a>Use the built-in help!</h3><p>GN has an extensive built-in help system which provides a reference for every function and built-in variable. This page is more high-level.</p><pre class="code">gn help
</pre><h3><a class="h" name="Design-philosophy" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Design-philosophy"><span></span></a>Design philosophy</h3><ul><li><p>Writing build files should not be a creative endeavour. Ideally two people should produce the same buildfile given the same requirements. There should be no flexibility unless it’s absolutely needed. As many things should be fatal errors as possible.</p></li><li><p>The definition should read more like code than rules. I don’t want to write or debug Prolog. But everybody on our team can write and debug C++ and Python.</p></li><li><p>The build language should be opinionated as to how the build should work. It should not necessarily be easy or even possible to express arbitrary things. We should be changing source and tooling to make the build simpler rather than making everything more complicated to conform to external requirements (within reason).</p></li><li><p>Be like Blaze when it makes sense (see “Differences and similarities to Blaze” below).</p></li></ul><h2><a class="h" name="Language" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Language"><span></span></a>Language</h2><p>GN uses an extremely simple, dynamically typed language. The types are:</p><ul><li>Boolean (<code>true</code>, <code>false</code>).</li><li>64-bit signed integers.</li><li>Strings</li><li>Lists (of any other types)</li><li>Scopes (sort of like a dictionary, only for built-in stuff)</li></ul><p>There are some built-in variables whose values depend on the current environment. See <code>gn help</code> for more.</p><p>There are purposefully many omissions in the language. There are no loops or function calls, for example. As per the above design philosophy, if you need this kind of thing you’re probably doing it wrong.</p><p>The variable <code>sources</code> has a special rule: when assigning to it, a list of exclusion patterns is applied to it. This is designed to automatically filter out some types of files. See <code>gn help
set_sources_assignment_filter</code> and <code>gn help patterns</code> for more.</p><h3><a class="h" name="Strings" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Strings"><span></span></a>Strings</h3><p>Strings are enclosed in double-quotes and use backslash as the escape character. The only escape sequences supported are</p><ul><li><code>\"</code> (for literal quote)</li><li><code>\$</code> (for literal dollars sign)</li><li><code>\\</code> (for literal backslash) Any other use of a backslash is treated as a literal backslash. So, for example, <code>\b</code> used in patterns does not need to be escaped, nor do most windows paths like <code>"C:\foo\bar.h"</code>.</li></ul><p>Simple variable substitution is supported via <code>$</code>, where the word following the dollars sign is replaced with the value of the variable. You can optionally surround the name with <code>{}</code> if there is not a non-variable-name character to terminate the variable name. More complex expressions are not supported, only variable name substitution.</p><pre class="code">a = "mypath"
b = "$a/foo.cc"  # b -&gt; "mypath/foo.cc"
c = "foo${a}bar.cc"  # c -&gt; "foomypathbar.cc"
</pre><h3><a class="h" name="Lists" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Lists"><span></span></a>Lists</h3><p>There is no way to get the length of a list. If you find yourself wanting to do this kind of thing, you’re trying to do too much work in the build.</p><p>Lists support appending:</p><pre class="code">a = [ "first" ]
a += [ "second" ]  # [ "first", "second" ]
a += [ "third", "fourth" ]  # [ "first", "second", "third", "fourth" ] 
b = a + [ "fifth" ]  # [ "first", "second", "third", "fourth", "fifth" ] 
</pre><p>Appending a list to another list appends the items in the second list rather than appending the list as a nested member.</p><p>You can remove items from a list:</p><pre class="code">a = [ "first", "second", "third", "first" ]
b = a - [ "first" ]  # [ "second", "third" ]
a -= [ "second" ]  # [ "first", "third", "fourth" ]
</pre><p>The - operator on a list searches for matches and removes all matching items. Subtracting a list from another list will remove each item in the second list.</p><p>If no matching items are found, an error will be thrown, so you need to know in advance that the item is there before removing it. Given that there is no way to test for inclusion, the main use-case is to set up a master list of files or flags, and to remove ones that don’t apply to the current build based on various conditions.</p><p>Lists support zero-based subscripting to extract values:</p><pre class="code">a = [ "first", "second", "third" ]
b = a[1]  # -&gt; "second"
</pre><p>The [] operator is read-only and can not be used to mutate the list. This is of limited value absent the ability to iterate over a list. The primary use-case of this is when an external script returns several known values and you want to extract them.</p><p>There are some cases where it’s easy to overwrite a list when you mean to append to it instead. To help catch this case, it is an error to assign a nonempty list to a variable containing an existing nonempty list. If you want to get around this restriction, first assign the destination variable to the empty list.</p><pre class="code">a = [ "one" ]
a = [ "two" ]  # Error: overwriting nonempty list with a nonempty list.
a = []         # OK
a = [ "two" ]  # OK
</pre><p>Note that execution of the build script is done without intrinsic knowledge of the meaning of the underlying data. This means that it doesn’t know that <code>sources</code> is a list of file names, for example. So if you remove an item, it must match the literal string rather than specifying a different name that will resolve to the same file name.</p><h3><a class="h" name="Conditionals" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Conditionals"><span></span></a>Conditionals</h3><p>Conditionals look like C:</p><pre class="code">  if (is_linux || (is_win &amp;&amp; target_cpu == "x86")) {
    sources -= [ "something.cc" ]
  } else if (...) {
    ...
  } else {
    ...
  }  
</pre><p>You can use them in most places, even around entire targets if the target should only be declared in certain circumstances.</p><h3><a class="h" name="Functions" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Functions"><span></span></a>Functions</h3><p>Simple functions look like most other languages:</p><pre class="code">print("hello, world")
assert(is_win, "This should only be executed on Windows")
</pre><p>Some functions take a block of code enclosed by <code>{ }</code> following them:</p><pre class="code">static_library("mylibrary") {
  sources = [ "a.cc" ]
}
</pre><p>This means that the block becomes an argument to the function for the function to execute. Most of the block-style functions execute the block and treat the resulting scope as a dictionary of variables to read.</p><h3><a class="h" name="Scoping-and-execution" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Scoping-and-execution"><span></span></a>Scoping and execution</h3><p>Files and <code>{ }</code> blocks introduce new scopes. Scoped are nested. When you read a variable, the containing scopes will be searched in reverse order until a matching name is found. Variable writes always go to the innermost scope.</p><p>There is no way to modify any enclosing scope other than the innermost one. This means that when you define a target, for example, nothing you do inside of the block will “leak out” into the rest of the file.</p><p><code>if</code>/<code>else</code> statements, even though they use <code>{ }</code>, do not introduce a new scope so changes will persist outside of the statement.</p><h2><a class="h" name="Naming-things" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Naming-things"><span></span></a>Naming things</h2><h3><a class="h" name="File-and-directory-names" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#File-and-directory-names"><span></span></a>File and directory names</h3><p>File and directory names are strings and are interpreted as relative to the current build file’s directory. There are three possible forms:</p><p>Relative names:</p><pre class="code">"foo.cc"
"src/foo.cc"
"../src/foo.cc"
</pre><p>Source-tree absolute names:</p><pre class="code">"//net/foo.cc"
"//base/test/foo.cc"
</pre><p>System absolute names (rare, normally used for include directories):</p><pre class="code">"/usr/local/include/"
"/C:/Program Files/Windows Kits/Include"
</pre><h3><a class="h" name="Labels" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Labels"><span></span></a>Labels</h3><p>Everything that can participate in the dependency graph (targets, configs, and toolchains) are identified by labels which are strings of a defined format. A common label looks like this:</p><pre class="code">"//base/test:test_support"
</pre><p>which consists of a source-root-absolute path, a colon, and a name. This means to look for the thing named “test_support” in <code>src/base/test/BUILD.gn</code>.</p><p>When loading a build file, if it doesn’t exist in the given location relative to the source root, GN will look in the secondary tree in <code>tools/gn/secondary</code>. This structure of this tree mirrors the main repository and is a way to add build files for directories that may be pulled from other repositories where we can’t easily check in BUILD files.</p><p>A canonical label also includes the label of the toolchain being used. Normally, the toolchain label is implicitly inherited, but you can include it to specify cross-toolchain dependencies (see “Toolchains” below).</p><pre class="code">"//base/test:test_support(//build/toolchain/win:msvc)"
</pre><p>In this case it will look for the a toolchain definition called “msvc” in the file <code>//build/toolchain/win</code> to know how to compile this target.</p><p>If you want to refer to something in the same buildfile, you can omit the path name and just start with a colon.</p><pre class="code">":base"
</pre><p>Labels can be specified as being relative to the current directory:</p><pre class="code">"source/plugin:myplugin"
"../net:url_request"
</pre><p>If a name is unspecified, it will inherit the directory name:</p><pre class="code">"//net" = "//net:net"
"//tools/gn" = "//tools/gn:gn"
</pre><h2><a class="h" name="Build-configuration" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Build-configuration"><span></span></a>Build configuration</h2><h3><a class="h" name="Overall-build-flow" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Overall-build-flow"><span></span></a>Overall build flow</h3><ol><li>Look for <code>.gn</code> file in the current directory and walk up the  directory tree until one is found. Set this directory to be the  “source root” and interpret this file to find the name of the build  config file.</li><li>Execute the build config file (this is the default toolchain).</li><li>Load the <code>BUILD.gn</code> file in the root directory.</li><li>Recursively load <code>BUILD.gn</code> in other directories to resolve all  current dependencies. If a BUILD file isn’t found in the specified  location, GN will look in the corresponding location inside  <code>tools/gn/secondary</code>.</li><li>When a target’s dependencies are resolved, write out the <code>.ninja</code>  file to disk.</li><li>When all targets are resolved, write out the root <code>build.ninja</code>  file.</li></ol><h3><a class="h" name="The-build-config-file" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#The-build-config-file"><span></span></a>The build config file</h3><p>The first file executed is the build config file. The name of this file is specified in the <code>.gn</code> file that marks the root of the repository. In Chrome it is <code>src/build/config/BUILDCONFIG.gn</code>. There is only one build config file.</p><p>This file sets up the scope in which all other build files will execute. Any arguments, variables, defaults, etc. set up in this file will be visible to all files in the build.</p><p>It is executed once for each toolchain (see “Toolchains”).</p><h3><a class="h" name="Build-arguments" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Build-arguments"><span></span></a>Build arguments</h3><p>Arguments can be passed in from the command line (and from other toolchains, see “Toolchains” below). You declare which arguments you accept and specify default values via <code>declare_args</code>.</p><p>See <code>gn help buildargs</code> for an overview of how this works. See <code>gn help
declare_args</code> for specifics on declaring them.</p><p>It is an error to declare a given argument more than once in a given scope. Typically arguments would be declared in an imported file (to share them among some subset of the build) or in the main build config file (to make them global).</p><h3><a class="h" name="Target-defaults" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Target-defaults"><span></span></a>Target defaults</h3><p>You can set up some default values for a given target type. This is normally done in the build config file to set a list of default configs that defines the build flags and other setup information for each target type.</p><p>See <code>gn help set_defaults</code>.</p><p>For example, when you declare a <code>static_library</code>, the target defaults for a static library are applied. These values can be overwritten, modified, or preserved by a target.</p><pre class="code"># This call is typically in the build config file (see above).
set_defaults("static_library") {
  configs = [ "//build:rtti_setup", "//build:extra_warnings" ]
}

# This would be in your directory's BUILD.gn file.
static_library("mylib") {
  # At this point configs is set to [ "//build:rtti_setup", "//build:extra_warnings" ]
  # by default but may be modified.
  configs -= "//build:extra_warnings"  # Don't want these warnings.
  configs += ":mylib_config"  # Add some more configs.
}
</pre><p>The other use-case for setting target defaults is when you define your own target type via <code>template</code> and want to specify certain default values.</p><h2><a class="h" name="Targets" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Targets"><span></span></a>Targets</h2><p>A target is a node in the build graph. It usually represents some kind of executable or library file that will be generated. Targets depend on other targets. The built-in target types (see <code>gn help &lt;targettype&gt;</code> for more help) are:</p><ul><li><code>action</code>: Run a script to generate a file.</li><li><code>action_foreach</code>: Run a script once for each source file.</li><li><code>component</code>: Configurable to be another type of library.</li><li><code>executable</code>: Generates an executable file.</li><li><code>group</code>: A virtual dependency node that refers to one or more other targets.</li><li><code>shared_library</code>: A .dll or .so.</li><li><code>source_set</code>: A lightweight virtual static library (usually preferrable over a real static library since it will build faster).</li><li><code>static_library</code>: A .lib or .a file (normally you’ll want a source_set instead).</li><li><code>test</code>: Generates an executable but annotates it as a test.</li></ul><p>You can extend this to make custom target types using templates (see below).</p><h2><a class="h" name="Configs" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Configs"><span></span></a>Configs</h2><p>Configs are named objects that specify sets of flags, include directories, and defines. They can be applied to a target and pushed to dependent targets.</p><p>To define a config:</p><pre class="code">config("myconfig") {
  includes = [ "src/include" ]
  defines = [ "ENABLE_DOOM_MELON" ]
}
</pre><p>To apply a config to a target:</p><pre class="code">executable("doom_melon") {
  configs = [ ":myconfig" ]
}
</pre><p>It is common for the build config file to specify target defaults that set a default list of configs. Targets can add or remove to this list as needed. So in practice you would usually use <code>configs += ":myconfig"</code> to append to the list of defaults.</p><p>See <code>gn help config</code> for more information about how configs are declared and applied.</p><h3><a class="h" name="Public-configs" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Public-configs"><span></span></a>Public configs</h3><p>A target can apply settings to other targets that depend on it. The most common example is a third party target that requires some defines or include directories for its headers to compile properly. You want these settings to apply both to the compile of the third party library itself, as well as all targets that use the library.</p><p>To do this, you write a config with the settings you want to apply:</p><pre class="code">config("my_external_library_config") {
  includes = "."
  defines = [ "DISABLE_JANK" ]
}
</pre><p>Then this config is added to the target as a “public” config. It will apply both to the target as well as targets that directly depend on it.</p><pre class="code">shared_library("my_external_library") {
  ...
  # Targets that depend on this get this config applied.
  public_configs = [ ":my_external_library_config" ]
}
</pre><p>Dependent targets can in turn forward this up the dependency tree another level by adding your target as a “public” dependency.</p><pre class="code">static_library("intermediate_library") {
  ...
  # Targets that depend on this one also get the configs from "my external library".
  public_deps = [ ":my_external_library" ]
}
</pre><p>A target can forward a config to all dependents until a link boundary is reached by setting it as an <code>all_dependent_config</code>. This is strongly discouraged.</p><h2><a class="h" name="Toolchains" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Toolchains"><span></span></a>Toolchains</h2><p>A toolchain is a set of build commands to run for different types of input files and link tasks.</p><p>You can have multiple toolchains in the build. It’s easiest to think about each one as completely separate builds that can additionally have dependencies between them. This means, for example, that the 32-bit Windows build might depend on a 64-bit helper target. Each of them can depend on <code>"//base:base"</code> which will be the 32-bit base in the context of the 32-bit toolchain, and the 64-bit base in the context of the 64-bit toolchain</p><p>When a target specifies a dependency on another target, the current toolchain is inherited unless it is explicitly overridden (see “Labels” above).</p><h3><a class="h" name="Toolchains-and-the-build-configuration" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Toolchains-and-the-build-configuration"><span></span></a>Toolchains and the build configuration</h3><p>When you have a simple build with only one toolchain, the build config file is loaded only once at the beginning of the build. It must call <code>set_default_toolchain</code> to tell GN the label of the toolchain definition to use. This toolchain definition has the commands to use for the compiler and linker. The <code>toolchain_args</code> section of the toolchain definition is ignored.</p><p>When a target has a dependency on a target using different toolchain, GN will start a build using that secondary toolchain to resolve the target. GN will load the build config file with the arguments specified in the toolchain definition. Since the toolchain is already known, calls to <code>set_default_toolchain</code> are ignored.</p><p>So the toolchain configuration is two-way. In the default toolchain (i.e. the main build target) the configuration flows from the build config file to the toolchain: the build config file looks at the state of the build (OS type, CPU architecture, etc.) and decides which toolchain to use (via <code>set_default_toolchain</code>). In secondary toolchains, the configuration flows from the toolchain to the build config file: the <code>toolchain_args</code> in the toolchain definition specifies the arguments to re-invoke the build.</p><h3><a class="h" name="Toolchain-example" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Toolchain-example"><span></span></a>Toolchain example</h3><p>Say the default build is a 64-bit build. Either this is the default CPU architecture based on the current system, or the user has passed <code>target_cpu="x64"</code> on the command line. The build config file might look like this to set up the default toolchain:</p><pre class="code"># Set default toolchain only has an effect when run in the context of
# the default toolchain. Pick the right one according to the current CPU
# architecture.
if (target_cpu == "x64") {
  set_default_toolchain("//toolchains:64")
} else if (target_cpu == "x86") {
  set_default_toolchain("//toolchains:32")
}
</pre><p>If a 64-bit target wants to depend on a 32-bit binary, it would specify a dependency using <code>datadeps</code> (data deps are like deps that are only needed at runtime and aren’t linked, since you can’t link a 32-bit and a 64-bit library).</p><pre class="code">executable("my_program") {
  ...
  if (target_cpu == "x64") {
    # The 64-bit build needs this 32-bit helper.
    datadeps = [ ":helper(//toolchains:32)" ]
  }
}

if (target_cpu == "x86") {
  # Our helper library is only compiled in 32-bits.
  shared_library("helper") {
    ...
  }
}
</pre><p>The toolchain file referenced above (<code>toolchains/BUILD.gn</code>) would define two toolchains:</p><pre class="code">toolchain("32") {
  tool("cc") {
    ...
  }
  ... more tools ...

  # Arguments to the build when re-invoking as a secondary toolchain.
  toolchain_args() {
    toolchain_cpu = "x86"
  }
}

toolchain("64") {
  tool("cc") {
    ...
  }
  ... more tools ...

  # Arguments to the build when re-invoking as a secondary toolchain.
  toolchain_args() {
    toolchain_cpu = "x64"
  }
}
</pre><p>The toolchain args specifies the CPU architecture explicitly, so if a target depends on something using that toolchain, that cpu architecture will be set when re-invoking the build. These args are ignored for the default toolchain since by the time they’re known the build config has already been run. In general, the toolchain args and the conditions used to set the default toolchain should agree.</p><p>The nice thing about the multiple-build setup is that you can write conditionals in your targets referencing the current toolchain state. The build files will be re-run with different state for each toolchain. For the <code>my_program</code> example above, you can see it queries the CPU architecture, adding a dependency only for the 64-bit build of the program. The 32-bit build would not get this dependency.</p><h3><a class="h" name="Declaring-a-toolchain" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Declaring-a-toolchain"><span></span></a>Declaring a toolchain</h3><p>Toolchains are declared with the <code>toolchain</code> command, which sets the commands to use for each compile and link operation. The toolchain also specifies a set of arguments to pass to the build config file when executing. This allows you to pass configuration information to the alternate toolchain.</p><h2><a class="h" name="Templates" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Templates"><span></span></a>Templates</h2><p>Templates are GN’s primary way to re-use code. Typically, a template would expand to one or more other target types.</p><pre class="code"># Declares static library consisting of rules to build all of the IDL files into
# compiled code.
template("idl") {
  source_set(target_name) {
    ...
  }
}
</pre><p>Typically your template definition would go in a <code>.gni</code> file and users would import that file to see the template definition:</p><pre class="code">import("//tools/idl_compiler.gni")

idl("my_interfaces") {
  sources = [ "a.idl", "b.idl" ]
}
</pre><p>Declaring a template creates a closure around the variables in scope at that time. When the template is invoked, the magic variable <code>invoker</code> is used to read variables out of the invoking scope. The template would generally copy the values its interested in into its own scope:</p><pre class="code">template("idl") {
  source_set(target_name) {
    sources = invoker.sources
  }
}
</pre><p>The current directory when a template executes will be that of the invoking build file rather than the template source file. This is so files passed in from the template invoker will be correct (this generally accounts for most file handling in a template). However, if the template has files itself (perhaps it generates an action that runs a script), you will want to use absolute paths (“//foo/…”) to refer to these files to account for the fact that the current directory will be unpredictable during invocation. See <code>gn help template</code> for more information and more complete examples.</p><h2><a class="h" name="Other-features" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Other-features"><span></span></a>Other features</h2><h3><a class="h" name="Imports" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Imports"><span></span></a>Imports</h3><p>You can import <code>.gni</code> files into the current scope with the <code>import</code> function. This is <em>not</em> an include. The imported file is executed independently and the resulting scope is copied into the current file. This allows the results of the import to be cached, and also prevents some of the more “creative” uses of includes.</p><p>Typically, a <code>.gni</code> would define build arguments and templates. See <code>gn
help import</code> for more.</p><h3><a class="h" name="Path-processing" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Path-processing"><span></span></a>Path processing</h3><p>Often you will want to make a file name or a list of file names relative to a different directory. This is especially common when running scripts, which are executed with the build output directory as the current directory, while build files usually refer to files relative to their containing directory.</p><p>You can use <code>rebase_path</code> to convert directories. See <code>gn help
rebase_path</code> for more help and examples. Typical usage to convert a file name relative to the current directory to be relative to the root build directory would be: <code>new_paths = rebase_path("myfile.c",
root_build_dir)</code></p><h3><a class="h" name="Patterns" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Patterns"><span></span></a>Patterns</h3><p>Patterns are used to generate the output file names for a given set of inputs for custom target types, and to automatically remove files from the <code>sources</code> variable (see <code>gn help set_sources_assignment_filter</code>).</p><p>They are like simple regular expressions. See <code>gn help patterns</code> for more.</p><h3><a class="h" name="Executing-scripts" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Executing-scripts"><span></span></a>Executing scripts</h3><p>There are two ways to execute scripts. All external scripts in GN are in Python. The first way is as a build step. Such a script would take some input and generate some output as part of the build. Targets that invoke scripts are declared with the “action” target type (see <code>gn help
action</code>).</p><p>The second way to execute scripts is synchronously during build file execution. This is necessary in some cases to determine the set of files to compile, or to get certain system configurations that the build file might depend on. The build file can read the stdout of the script and act on it in different ways.</p><p>Synchronous script execution is done by the <code>exec_script</code> function (see <code>gn help exec_script</code> for details and examples). Because synchronously executing a script requires that the current buildfile execution be suspended until a Python process completes execution, relying on external scripts is slow and should be minimized.</p><p>You can synchronously read and write files which is occasionally necessary when synchronously running scripts. The typical use-case would be to pass a list of file names longer than the command-line limits of the current platform. See <code>gn help read_file</code> and <code>gn help write_file</code> for how to read and write files. These functions should be avoided if at all possible.</p><h1><a class="h" name="Differences-and-similarities-to-Blaze" href="https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/language.md#Differences-and-similarities-to-Blaze"><span></span></a>Differences and similarities to Blaze</h1><p><a href="http://google-engtools.blogspot.com/2011/08/build-in-cloud-how-build-system-works.html">Blaze</a> is Google’s internal build system. It has inspired a number of other systems such as <a href="https://github.com/twitter/commons/tree/master/src/python/twitter/pants">Pants</a> and <a href="http://facebook.github.io/buck/">Buck</a>.</p><p>In Google’s homogeneous environment, the need for conditionals is very low and they can get by with a few hacks (<code>abi_deps</code>). Chrome uses conditionals all over the place and the need to add these is the main reason for the files looking different.</p><p>GN also adds the concept of “configs” to manage some of the trickier dependency and configuration problems which likewise don’t arise on the server. Blaze has a concept of a “configuration” which is like a GN toolchain, but built into the tool itself. The way that toolchains work in GN is a result of trying to separate this concept out into the build files in a clean way.</p><p>GN keeps some GYP concept like “all dependent” and “direct dependent” settings which work a bit differently in Blaze. This is partially to make conversion from the existing GYP code easier, and the GYP constructs generally offer more fine-grained control (which is either good or bad, depending on the situation).</p><p>GN also uses GYP names like “sources” instead of “srcs” since abbreviating this seems needlessly obscure, although it uses Blaze’s “deps” since “dependencies” is so hard to type. Chromium also compiles multiple languages in one target so specifying the language type on the target name prefix was dropped (e.g. from <code>cc_library</code>).</p></div><div class="footer-break"></div><div class="footer-line"><div class="nav-aux"><ul><li><a href="https://chromium.googlesource.com/chromium/src/+show/master/tools/gn/docs/language.md">source</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+log/master/tools/gn/docs/language.md">log</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+blame/master/tools/gn/docs/language.md">blame</a></li></ul><div class="gitiles-att">Powered by <a href="https://code.google.com/p/gitiles/">Gitiles</a></div></div></div><script async="" src="./GN Language and Operation_files/analytics.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-55762617-15', 'auto'); ga('send', 'pageview', {title: 'GN Language and Operation'});</script></body></html>